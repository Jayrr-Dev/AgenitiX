import type { NodeProps } from '@xyflow/react';
import { useState } from 'react';
import { z } from 'zod';

import { withNodeScaffold } from '@/features/business-logic-modern/infrastructure/node-core/withNodeScaffold';
import type { NodeSpec } from '@/features/business-logic-modern/infrastructure/node-core/NodeSpec';
import {
  createNodeValidator,
  CommonSchemas,
  reportValidationError,
  useNodeDataValidation
} from '@/features/business-logic-modern/infrastructure/node-core/validation';
import { SafeSchemas, createSafeInitialData } from '@/features/business-logic-modern/infrastructure/node-core/schema-helpers';
import { CATEGORIES } from '@/features/business-logic-modern/infrastructure/theming/categories';
import { EXPANDED_SIZES, COLLAPSED_SIZES } from '@/features/business-logic-modern/infrastructure/theming/sizing';
import { ExpandCollapseButton } from '@/components/nodes/ExpandCollapseButton';

// -- PLOP-INJECTED-IMPORTS --

/**
 * {{titleCase kind}} NODE - Simple node with schema-driven controls
 *
 * â€¢ Clean, simple UI with schema-driven controls in Node Inspector
 * â€¢ Type-safe data validation with Zod schema
 * â€¢ Zero-maintenance control system
 * â€¢ Enterprise-grade backend safety
 *
 * Keywords: {{kebabCase kind}}, simple-ui, schema-driven, type-safe
 */

/**
 * Data schema for {{titleCase kind}} node
 * Define your node's data structure - controls are automatically generated
 */
const {{pascalCase kind}}DataSchema = z.object({
  // Basic fields - customize as needed
  text: SafeSchemas.text('Default text'),
  isEnabled: SafeSchemas.boolean(true),
  isActive: SafeSchemas.boolean(false),

  // Add your fields here - controls are auto-generated:
  // description: SafeSchemas.optionalText(),
  // count: SafeSchemas.number(1, 1, 100),
  // priority: SafeSchemas.enum(['low', 'medium', 'high'], 'medium'),
}).strict();

type {{pascalCase kind}}Data = z.infer<typeof {{pascalCase kind}}DataSchema>;

// Create enterprise validator
const validateNodeData = createNodeValidator({{pascalCase kind}}DataSchema, '{{pascalCase kind}}');

/**
 * Node specification with schema-driven controls
 */
const spec: NodeSpec = {
  kind: '{{camelCase kind}}',
  displayName: '{{camelCase kind}}',
  category: CATEGORIES.{{constantCase category}},
  size: {
    expanded: {{expandedSizeConstant expandedSize}},
    collapsed: {{collapsedSizeConstant collapsedSize}},
  },
  handles: [
    { id: 'json-input', code: 'j', position: 'top', type: 'target' },
    { id: 'output', code: 's', position: 'right', type: 'source' },
    { id: 'activate', code: 'b', position: 'left', type: 'target' },
  ],
  inspector: {
    key: '{{pascalCase kind}}Inspector',
  },
  initialData: createSafeInitialData({{pascalCase kind}}DataSchema),
  dataSchema: {{pascalCase kind}}DataSchema,
};

/**
 * {{camelCase kind}} Node Component
 *
 * Simple UI with schema-driven controls:
 * - Clean interface focused on node-specific functionality
 * - Schema-driven controls available in Node Inspector
 * - Maintains enterprise validation and type safety
 */
const {{pascalCase kind}}NodeComponent = ({ data, id }: NodeProps) => {
  const [isExpanded, setExpanded] = useState(false);

  // Enterprise validation with comprehensive error handling
  const validationResult = validateNodeData(data);
  const nodeData = validationResult.data;

  // Report validation errors for monitoring
  if (!validationResult.success) {
    reportValidationError('{{pascalCase kind}}', id, validationResult.errors, {
      originalData: validationResult.originalData,
      component: '{{pascalCase kind}}NodeComponent',
    });
  }

  // Enterprise data validation hook for real-time updates
  const { getHealthScore } = useNodeDataValidation(
    {{pascalCase kind}}DataSchema,
    '{{pascalCase kind}}',
    nodeData,
    id
  );

  const onToggle = () => setExpanded((prev) => !prev);

  // Use the spec.size for strict sizing
  const { expanded, collapsed } = spec.size;
  const nodeSize = isExpanded ? expanded : collapsed;
  const dims = nodeSize as { width: number | string; height: number | string };
  const width = typeof dims.width === 'number' ? `${dims.width}px` : dims.width;
  const height = typeof dims.height === 'number' ? `${dims.height}px` : dims.height;

  return (
    <div
      className={`relative bg-white dark:bg-neutral-900 rounded-lg shadow-md border border-neutral-200 dark:border-neutral-700 transition-all duration-200 ${
        isExpanded ? '' : 'flex items-center justify-center'
      }`}
      style={{ width, height, minWidth: width, minHeight: height }}
      data-testid="{{kebabCase kind}}-node"
    >
      <ExpandCollapseButton showUI={isExpanded} onToggle={onToggle} size="sm" />

      {isExpanded ? (
        <div className="p-4 pt-8 w-full h-full flex flex-col">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-semibold">{{camelCase kind}}</h3>
            {process.env.NODE_ENV === 'development' && (
              <span className="text-xs text-gray-500">
                Health: {getHealthScore()}%
              </span>
            )}
          </div>

          {/* Add your node-specific UI here */}
          <div className="flex-1 flex items-center justify-center text-gray-500">
            <div className="text-center">
              <div className="text-2xl mb-2">ðŸ”§</div>
              <div className="text-xs">
                {nodeData.isEnabled ? nodeData.text : 'Disabled'}
              </div>
            </div>
          </div>
        </div>
      ) : (
        <div className="flex items-center justify-center w-full h-full">
          <span className="text-2xl" aria-label="{{titleCase kind}} Node">
            ðŸ”§
          </span>
        </div>
      )}
    </div>
  );
};

export default withNodeScaffold(spec, {{pascalCase kind}}NodeComponent);

// Export spec for registry access
export { spec };
